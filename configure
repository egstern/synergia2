#!/bin/sh

# usage: subst <string> <replacement string> <input file> <output file>
subst () {
    instr="$1"
    outstr="$2"
    infile="$3"
    outfile="$4"
     if [ ! -f "$infile" ]; then
        echo "subst: no such file '$infile'" >&2
        exit 1
    fi
    cat "$infile" | sed "s@$instr@$outstr@g" > subst.tmp
    mv subst.tmp "$outfile"
}

init_vars () {
    prefix=/usr/local
    synergia2_build_dir="`cd \"\`dirname $0\`\";/bin/pwd`"
    python_prefix=/usr
    boost_prefix=/usr
    fftw_prefix=/usr
    chef_prefix=/usr/local
    impact_build_dir=/usr/local/src/impact
}

parse_args () {
    error=""
    for arg in "$@"
    do
        found=""
        var=`echo "$arg" | sed 's/--with-\(.*\)=\(.*\)/\1/'`
        val=`echo "$arg" | sed 's/--with-\(.*\)=\(.*\)/\2/'`
        case $var in
            --prefix=*)
                prefix="`echo "$arg" | sed 's/.*=//'`"
                found=true
                ;;
            python-prefix)
                python_prefix="$val"
                found=true
                ;;
            boost-prefix)
                boost_prefix="$val"
                found=true
                ;;
            fftw-prefix)
                fftw_prefix="$val"
                found=true
                ;;
            chef-prefix)
                chef_prefix="$val"
                found=true
                ;;
            impact-build-dir)
                impact_build_dir="$val"
                found=true
                ;;
            *)
                if [ -z "$found" ]; then
                    echo "error: unknown argument '$arg'" >&2
                    error=true
                fi
                ;;
            esac
    done

    if [ -n "$error" ]; then
        exit 1
    fi
}

do_substitutions () {
    for f in make_defines local_paths.py
    do
        subst _subst_SYNERGIA2_BUILD_DIR_subst_ "$synergia2_build_dir" $f.in $f
        subst _subst_PREFIX_subst_ "$prefix" $f $f
        subst _subst_PYTHON_INSTALL_DIR_subst_ "$python_prefix" $f $f
        subst _subst_BOOST_INSTALL_DIR_subst_ "$boost_prefix" $f $f
        subst _subst_FFTW_INSTALL_DIR_subst_ "$fftw_prefix" $f $f
        subst _subst_CHEF_INSTALL_DIR_subst_ "$chef_prefix" $f $f
        subst _subst_IMPACT_BUILD_DIR_subst_ "$impact_build_dir" $f $f
    done
}

record_arguments () {
    /bin/rm -f config.status
    echo -n "$0" >> config.status
    for arg in "$@"
    do
        echo -n " '$arg'" >> config.status
    done
    echo >> config.status
}

display_configuration () {
    echo "prefix='$prefix'"
    echo "synergia2_build_dir='$synergia2_build_dir'"
    echo "python_prefix='$python_prefix'"
    echo "boost_prefix='$boost_prefix'"
    echo "fftw_prefix='$fftw_prefix'"
    echo "chef_prefix='$chef_prefix'"
    echo "impact_build_dir='$impact_build_dir'"
}


init_vars
parse_args "$@"
do_substitutions
record_arguments "$@"
display_configuration
